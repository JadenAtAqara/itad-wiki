# 流程

> **说明**
>
> 截图与实际界面可能有所不同，请以实际为准。

## 概述

除了基础的“当-且-就“流程逻辑之外，Aqara Studio 的自动化配置还支持加入更进阶的逻辑环节，如 [循环执行](#循环执行)、[限制触发次数](#限制触发次数)、[达到指定次数时触发](#达到指定次数时触发) 和 [场景切换](#场景切换)。

流程类包含的卡片如下图所示：

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-Total.png" alt="流程类卡片概览" style={{ width: '80%' }} />   
## 循环执行

### 功能

当您希望**重复执行某个行为**时，可使用此卡片实现循环控制，灵活构建定时循环的自动化流程。

### 组成

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-LoopIntro.png" alt="循环执行组成" style={{ width: '80%' }} />   
此卡片为**双点**类型，有 **1 个输入点**、**1 个输出点**和 **2 个配置参数**，具体说明如下：

| 连接点或参数 | 是否必选 | 说明 |
| -- | -- | -- |
| 激活（输入点） | ✔ | 用于控制循环的开始和结束。<br />根据控制方式不同，连接的卡片也不同：<ul><li><strong>单一布尔值：</strong>循环开始与结束由同一个布尔值控制，例如“门打开 → 开始循环；门关闭 → 结束循环”。需连接 <a href="./variables-blocks.mdx#赋值变量">赋值变量</a> 卡片。</li><li><strong>两个事件：</strong>循环开始与结束由两个不同事件控制，例如“门打开 → 开始循环；窗户关闭 → 停止循环”。需连接 <a href="./device-blocks.mdx#当">当</a> 卡片。</li></ul> |
| 循环间隔 | ✔ | 设置每次执行之间的等待时间。您可以选择以秒、分钟或小时为单位。 |
| 首次执行等待 | ✘ | **首次执行前的等待时长。** 循环开始后，将先等待此时长再首次执行目标行为，后续每轮等待时间则以“循环间隔”为准。<br />合理设置该参数可避免设备争抢资源或多组循环同时启动，适合设备初始化预热、错峰启动等场景。 |
| 每次（输出点） | ✔ | 连接到您希望重复执行的行为。 |

### 使用步骤

根据控制循环的布尔值数量，使用 `循环操作`卡片的步骤也有所不同。

#### 单一布尔值

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-Loop.png" alt="循环执行" style={{ width: '80%' }} />   
当使用 1 个布尔值控制循环时，`循环执行`卡片的使用步骤如下：

1. 在卡片左侧连接 1 个 `布尔型赋值变量`卡片（如中为 Aqara LED Light T1 的开关状态变量），由此，设备实时状态会传递到`循环执行`卡片， 从而开始或停止循环。
2. 设置循环间隔，即每次执行之间的时间间隔（支持秒、分钟或小时为单位）。
3. 在卡片右侧连接需要重复执行的具体行为。

#### 两个事件

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-LoopWith2Booleans.png" alt="使用 2 个布尔值控制循环" style={{ width: '80%' }} />   
当使用 2 个事件控制循环时，`循环执行`卡片的使用步骤如下：

1. 添加 2 个不同 `当` 卡片，并将它们的输出点同时连接到 `循环执行` 卡片的输入点。此时，你会 `当` 卡片和 `循环执行` 卡片中间出现 `数值转换`卡片。这意味着您可以将事件或状态转换成布尔值并传递给`循环执行`卡片。
2. 你需要规定哪个`当`卡片应当转换成 `true`（表示开始循环）、哪个为 `false`（表示结束循环）。
3. 设置循环间隔，即每次执行之间的时间间隔（支持秒、分钟或小时为单位）。
4. 在卡片右侧连接需要重复执行的具体行为。

## 限制触发次数

### 功能

您可以使用此卡片为触发行为设置次数上限，从而控制目标动作的执行次数。

### 组成

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-ReachLimitIntro.png" alt="限制触发次数卡片说明" style={{ width: '80%' }} />   
此卡片为多点类型，有 2 个输入点、1 个输出点和 1 个配置参数，具体说明如下：

| 连接点或参数 | 是否必选 | 说明 |
| -- | -- | -- |
| 重置（输入点） | ✔ | 当连接的动作发生时，将计数清零。 |
| +1（输入点） | ✔ | 当连接的动作发生时，计数加一，并触发输出点连接的目标行为。 |
| 次数上限 | ✔ | 设定目标行为可被触发的最大次数。 |
| 输出点 | ✔ | 连接到待触发的目标行为。 |

### 使用步骤

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-TiggerCountLimit.png" alt="限制触发次数" style={{ width: '80%' }} />   
`限制触发次数`卡片的使用步骤如下所示：

1. 在左侧 **“+1” 输入点** 连接 1 个行为，该行为会同时增加计数并触发目标行为。
2. 在左侧 **“重置” 输入点** 连接 1 个行为，这个行为会将计数清零。
3. 在卡片内配置目标行为的最大触发次数。
4. 在右侧 **输出点** 连接需要触发的目标行为，该目标行为将仅能被 “+1” 输入点触发到设定的上限次数。

## 达到指定次数时触发

### 功能

使用这个卡片，你可以设置一个行为在特定次数的其他行为发生后才被触发，以此避免误触行为。

### 组成

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-TriggerAfterCountIntro.png" alt="达到指定次数时触发介绍" style={{ width: '80%' }} />   
此卡片为多点类型，有 2 个输入点、1 个输出点和 1 个配置参数，具体说明如下：

| 连接点或参数 | 是否必选 | 说明 |
| -- | -- | -- |
| 重置（输入点） | ✔ | 当连接的动作发生时，将计数归零。 |
| +1（输入点） | ✔ | 当连接的动作发生时，开始计数。 |
| 计数目标 | ✔ | 设置计数目标，作为触发目标行为的门槛。 |
| 输出点 | ✔ | 连接待触发目标行为。 |

### 使用步骤

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-TiggerAfterCount.png" alt="达到指定次数时触发" style={{ width: '80%' }} />   
`到达指定次数时触发`卡片的使用步骤如下：
1. 将需要计数的行为连接到卡片左侧的 **“+1” 输入点**，将用于重置计数的行为连接到 **“重置” 输入点**。
2. 在卡片内设置 **计数目标**，即达到多少次后触发目标行为。
3. 在卡片右侧 **输出点** 连接你希望在达到指定次数后触发的目标行为。
4.当 “+1” 输入点连接的行为累计发生次数达到你设定的计数目标时，目标行为会被自动触发。

## 场景切换

### 功能

如果您希望设备根据不同场景进行不同的行为，可使用此卡片。

### 组成

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-ModeSwitch.png" alt="场景切换卡片组成" style={{ width: '80%' }} />   
此卡片为多点类型，有 1 个输入点、多个输出点、1 个配置参数和 1 个按钮，具体说明如下：

<table>
  <thead>
    <tr>
      <th>连接点或参数</th>
      <th>是否必选</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>选择（输入点）</td>
      <td rowspan="2">二者必选其一</td>
      <td>连接数值类卡片时，您可根据数值选择场景。</td>
    </tr>
    <tr>
      <td>下一个（输入点）</td>
      <td>连接一个 <a href="./device-blocks.mdx#当">当</a> 卡片，表示当这个事件或状态发生时候，就开始切换到下一个场景。</td>
    </tr>
    <tr>
      <td>场景 1（输出点）</td>
      <td>✔</td>
      <td>连接 1 个 <a href="./device-blocks.mdx#就">就</a>卡片。</td>
    </tr>
    <tr>
      <td>场景 2（输出点）</td>
      <td>✔</td>
      <td>连接 1 个 <a href="./device-blocks.mdx#就">就</a>卡片。</td>
    </tr>
    <tr>
      <td>添加按钮</td>
      <td>✘</td>
      <td>可用于增加更多场景，以连接更多行为。</td>
    </tr>
  </tbody>
</table>

### 使用步骤

<img src="https://itad-aqara-docs-1300889962.aqara.com/dev/img/aqara-studio/zh/FlowBlock-ModeSwitchSteps.png" alt="场景切换步骤" style={{ width: '80%' }} />   
上图展示了使用`下一个`输入点触发`场景切换`卡片，使用步骤说明如下：
1. 在 `场景切换` 卡片左侧 `下一个` 输入点连接 1 个 `当` 卡片。
2. 在 `场景切换` 卡片右侧 `场景 1` 和 `场景 2` 输出点连接不同的 `就` 卡片。